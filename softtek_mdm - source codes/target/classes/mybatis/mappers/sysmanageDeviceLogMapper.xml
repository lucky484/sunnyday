<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.softtek.mdm.dao.SysmanageDeviceLogDao">
	<resultMap id="BaseResultMap" type="com.softtek.mdm.model.SysmanageDeviceLog">
		<!-- WARNING - @mbggeneratedqueryDeviceLogCountByParams This element is automatically generated by 
			MyBatis Generator, do not modify. -->
		<id column="id" property="id" jdbcType="INTEGER" />
		<result column="user_id" property="userId" jdbcType="INTEGER" />
		<result column="user_name" property="userName" jdbcType="VARCHAR" />
		<result column="device_id" property="deviceId" jdbcType="INTEGER" />
		<result column="org_id" property="orgId" jdbcType="INTEGER" />
		<result column="operate_date" property="operateDate" jdbcType="TIMESTAMP" />
		<result column="event_type" property="eventType" jdbcType="CHAR" />
		<result column="operate_content" property="operateContent"
			jdbcType="VARCHAR" />
		<result column="create_date" property="createDate" jdbcType="TIMESTAMP" />
		<result column="create_user" property="createUser" jdbcType="INTEGER" />
		<result column="update_date" property="updateDate" jdbcType="TIMESTAMP" />
		<result column="update_user" property="updateUser" jdbcType="INTEGER" />
		<result column="delete_time" property="deleteTime" jdbcType="TIMESTAMP" />
	</resultMap>

	<resultMap id="DeviceLogMap" type="com.softtek.mdm.model.SysmanageDeviceLog">
		<!-- WARNING - @mbggenerated This element is automatically generated by 
			MyBatis Generator, do not modify. -->
		<id column="id" property="id" jdbcType="INTEGER" />
		<result column="user_id" property="userId" jdbcType="INTEGER" />
		<result column="device_id" property="deviceId" jdbcType="INTEGER" />
		<result column="org_id" property="orgId" jdbcType="INTEGER" />
		<result column="operate_date" property="operateDate" jdbcType="TIMESTAMP" />
		<result column="event_type" property="eventType" jdbcType="CHAR" />
		<result column="operate_content" property="operateContent"
			jdbcType="VARCHAR" />
		<result column="create_date" property="createDate" jdbcType="TIMESTAMP" />
		<result column="create_user" property="createUser" jdbcType="INTEGER" />
		<result column="update_date" property="updateDate" jdbcType="TIMESTAMP" />
		<result column="update_user" property="updateUser" jdbcType="INTEGER" />
		<result column="delete_time" property="deleteTime" jdbcType="TIMESTAMP" />

		<association property="usermodel" javaType="User">
			<id property="id" column="user_id" />
			<result property="realname" column="real_name" />
		</association>

	</resultMap>
	<resultMap id="deviceOperateLogMap" type="com.softtek.mdm.model.SysmanageDeviceLog">
		<id column="id" property="id" />
		<result column="event_type" property="eventType" />
		<result column="device_name" property="deviceName" />
		<result column="user_name" property="userName" />
		<result property="realName" column="real_name" />
		<result column="operate_date" property="operateDate" />
		<result column="operate_content" property="operateContent" />
		<result column="name" property="name" />
	</resultMap>

	<sql id="Base_Column_List">
		<!-- WARNING - @mbggenerated This element is automatically generated by 
			MyBatis Generator, do not modify. -->
		id, user_id,user_name, device_id, org_id, operate_date, event_type,
		operate_content, create_date,
		create_user, update_date, update_user, delete_time
	</sql>
	<select id="selectByPrimaryKey" resultMap="BaseResultMap"
		parameterType="java.lang.Integer">
		<!-- WARNING - @mbggenerated This element is automatically generated by 
			MyBatis Generator, do not modify. -->
		select
		<include refid="Base_Column_List" />
		from sysmanage_device_log
		where id = #{id,jdbcType=INTEGER}
	</select>
	<delete id="deleteByPrimaryKey" parameterType="java.lang.Integer">
		<!-- WARNING - @mbggenerated This element is automatically generated by 
			MyBatis Generator, do not modify. -->
		delete from sysmanage_device_log
		where id = #{id,jdbcType=INTEGER}
	</delete>
	<insert id="insert" parameterType="com.softtek.mdm.model.SysmanageDeviceLog">
		<!-- WARNING - @mbggenerated This element is automatically generated by 
			MyBatis Generator, do not modify. -->
		insert into sysmanage_device_log (id, user_id,user_name, device_id,
		org_id, operate_date, event_type,
		operate_content, create_date, create_user,
		update_date, update_user, delete_time
		)
		values (#{id,jdbcType=INTEGER}, #{userId,jdbcType=INTEGER},
		#{userName,jdbcType=VARCHAR}, #{deviceId,jdbcType=INTEGER},
		#{orgId,jdbcType=INTEGER}, #{operateDate,jdbcType=TIMESTAMP},
		#{eventType,jdbcType=CHAR},
		#{operateContent,jdbcType=VARCHAR}, #{createDate,jdbcType=TIMESTAMP}, #{createUser,jdbcType=INTEGER},
		#{updateDate,jdbcType=TIMESTAMP}, #{updateUser,jdbcType=INTEGER},
		#{deleteTime,jdbcType=TIMESTAMP}
		)
	</insert>
	<insert id="insertSelective" parameterType="com.softtek.mdm.model.SysmanageDeviceLog"
		keyProperty="id" useGeneratedKeys="true">
		<!-- WARNING - @mbggenerated This element is automatically generated by 
			MyBatis Generator, do not modify. -->
		insert into sysmanage_device_log
		<trim prefix="(" suffix=")" suffixOverrides=",">
			<if test="userId != null">
				user_id,
			</if>
			<if test="userName != null">
				user_name,
			</if>
			<if test="deviceId != null">
				device_id,
			</if>
			<if test="deviceName != null">
				device_name,
			</if>
			<if test="orgId != null">
				org_id,
			</if>
			<if test="operateDate != null">
				operate_date,
			</if>
			<if test="eventType != null">
				event_type,
			</if>
			<if test="operateContent != null">
				operate_content,
			</if>
			<if test="createDate != null">
				create_date,
			</if>
			<if test="createUser != null">
				create_user,
			</if>
			<if test="updateDate != null">
				update_date,
			</if>
			<if test="updateUser != null">
				update_user,
			</if>
			<if test="deleteTime != null">
				delete_time,
			</if>
		</trim>
		<trim prefix="values (" suffix=")" suffixOverrides=",">
			<if test="userId != null">
				#{userId,jdbcType=INTEGER},
			</if>
			<if test="userName != null">
				#{userName,jdbcType=VARCHAR},
			</if>
			<if test="deviceId != null">
				#{deviceId,jdbcType=INTEGER},
			</if>
			<if test="deviceName != null">
				#{deviceName,jdbcType=VARCHAR},
			</if>
			<if test="orgId != null">
				#{orgId,jdbcType=INTEGER},
			</if>
			<if test="operateDate != null">
				#{operateDate,jdbcType=TIMESTAMP},
			</if>
			<if test="eventType != null">
				#{eventType,jdbcType=CHAR},
			</if>
			<if test="operateContent != null">
				#{operateContent,jdbcType=VARCHAR},
			</if>
			<if test="createDate != null">
				#{createDate,jdbcType=TIMESTAMP},
			</if>
			<if test="createUser != null">
				#{createUser,jdbcType=INTEGER},
			</if>
			<if test="updateDate != null">
				#{updateDate,jdbcType=TIMESTAMP},
			</if>
			<if test="updateUser != null">
				#{updateUser,jdbcType=INTEGER},
			</if>
			<if test="deleteTime != null">
				#{deleteTime,jdbcType=TIMESTAMP},
			</if>
		</trim>
	</insert>
	<update id="updateByPrimaryKeySelective" parameterType="com.softtek.mdm.model.SysmanageDeviceLog">
		<!-- WARNING - @mbggenerated This element is automatically generated by 
			MyBatis Generator, do not modify. -->
		update sysmanage_device_log
		<set>
			<if test="userId != null">
				= #{userId,jdbcType=INTEGER},
			</if>
			<if test="realName != null">
				user_name = #{userName,jdbcType=VARCHAR},
			</if>
			<if test="deviceId != null">
				device_id = #{deviceId,jdbcType=INTEGER},
			</if>
			<if test="orgId != null">
				org_id = #{orgId,jdbcType=INTEGER},
			</if>
			<if test="operateDate != null">
				operate_date = #{operateDate,jdbcType=TIMESTAMP},
			</if>
			<if test="eventType != null">
				event_type = #{eventType,jdbcType=CHAR},
			</if>
			<if test="operateContent != null">
				operate_content = #{operateContent,jdbcType=VARCHAR},
			</if>
			<if test="createDate != null">
				create_date = #{createDate,jdbcType=TIMESTAMP},
			</if>
			<if test="createUser != null">
				create_user = #{createUser,jdbcType=INTEGER},
			</if>
			<if test="updateDate != null">
				update_date = #{updateDate,jdbcType=TIMESTAMP},
			</if>
			<if test="updateUser != null">
				update_user = #{updateUser,jdbcType=INTEGER},
			</if>
			<if test="deleteTime != null">
				delete_time = #{deleteTime,jdbcType=TIMESTAMP},
			</if>
		</set>
		where id = #{id,jdbcType=INTEGER}
	</update>
	<update id="updateByPrimaryKey" parameterType="com.softtek.mdm.model.SysmanageDeviceLog">
		<!-- WARNING - @mbggenerated This element is automatically generated by 
			MyBatis Generator, do not modify. -->
		update sysmanage_device_log
		set user_id = #{userId,jdbcType=INTEGER},
		user_name = #{userName,jdbcType=VARCHAR},
		device_id = #{deviceId,jdbcType=INTEGER},
		org_id = #{orgId,jdbcType=INTEGER},
		operate_date = #{operateDate,jdbcType=TIMESTAMP},
		event_type = #{eventType,jdbcType=CHAR},
		operate_content = #{operateContent,jdbcType=VARCHAR},
		create_date = #{createDate,jdbcType=TIMESTAMP},
		create_user = #{createUser,jdbcType=INTEGER},
		update_date = #{updateDate,jdbcType=TIMESTAMP},
		update_user = #{updateUser,jdbcType=INTEGER},
		delete_time = #{deleteTime,jdbcType=TIMESTAMP}
		where id = #{id,jdbcType=INTEGER}
	</update>

	<select id="getAllDeviceLogType" resultType="java.lang.String">
		<!-- WARNING - @mbggenerated This element is automatically generated by 
			MyBatis Generator, do not modify. -->
		SELECT distinct(event_type) FROM sysmanage_device_log where event_type
		is not null and event_type != '';

	</select>

	<select id="queryAllCountByParams" resultType="java.lang.Integer">
		select count(1) from sysmanage_device_log where device_id = #{did}
		and user_id = #{uid}
		<if test="eventType != null and eventType !=''">
			and event_type = #{eventType}
		</if>
		<!-- 查询条件：创建开始时间 -->
		<if test="startTime!=null and startTime!=''">
			AND operate_date between CONCAT(#{startTime},' :00:00:00')
		</if>
		<!-- 查询条件：创建结束时间 -->
		<if test="endTime!=null and endTime!=''">
			AND CONCAT(#{endTime},' :23:59:59')
		</if>
	</select>

	<select id="queryDeviceLogList" resultMap="DeviceLogMap">
		select
		dl.id,user_id,real_name,event_type,operate_date,operate_content from sysmanage_device_log dl left join
		users u on u.id = dl.user_id
		where device_id = #{did} and user_id = #{uid}
		<if test="eventType != null">
			and event_type = #{eventType}
		</if>
		<!-- 查询条件：创建开始时间 -->
		<if test="startTime!=null and startTime!=''">
			AND operate_date between CONCAT(#{startTime},' :00:00:00')
		</if>
		<!-- 查询条件：创建结束时间 -->
		<if test="endTime!=null and endTime!=''">
			AND CONCAT(#{endTime},' :23:59:59')
		</if>
		order by operate_date desc
		limit #{start},#{offset}
	</select>

	<select id="findRecordsByMap" resultMap="DeviceLogMap">
		select
		dl.id,user_id,real_name,event_type,operate_date,operate_content from
		sysmanage_device_log dl left join
		users u on u.id = dl.user_id
		where device_id = #{did}
		AND dl.delete_time is null
		order by operate_date desc
		limit #{pageNum},#{pageSize}
	</select>

	<select id="findRecordsCountByDeviceId" parameterType="java.lang.Integer"
		resultType="java.lang.Integer">
		select
		count(1)
		from sysmanage_device_log dl left join
		users u on u.id = dl.user_id
		where device_id = #{did}
		AND dl.delete_time is null
	</select>
	<!-- 设备日志分页查询 -->
	<select id="queryDeviceLog" resultMap="deviceOperateLogMap">
		select
		d.id,
		d.event_type,
		d.device_name,
		d.user_name,
		d.operate_date,
		d.operate_content,
		o.name
		from
		sysmanage_device_log d,
		organization o
		where d.org_id = o.id
		and d.delete_time is null
		<if test="type != null">
			and d.event_type = #{type}
		</if>
		<if test="deviceName != null and deviceName != ''">
			and d.device_name like CONCAT('%',#{deviceName},'%')
		</if>
		<if test="userName != null and userName != ''">
			and d.user_name like CONCAT('%',#{userName},'%')
		</if>
		<if test="orgId != null and orgId != ''">
			and d.org_id = #{orgId}
		</if>
		order by d.update_date desc
		limit #{begin},#{num}
	</select>

	<select id="queryDeviceLogCountByParams" resultType="int"
		parameterType="int">
		select count(1) from
		sysmanage_device_log d,
		organization o
		where d.org_id = o.id
		and d.delete_time is null
		<if test="type != null">
			and d.event_type = #{type}
		</if>
		<if test="deviceName != null and deviceName != ''">
			and d.device_name like CONCAT('%',#{deviceName},'%')
		</if>
		<if test="userName != null and userName != ''">
			and d.user_name like CONCAT('%',#{userName},'%')
		</if>
		<if test="orgId != null and orgId != ''">
			and d.org_id = #{orgId}
		</if>
	</select>

	<select id="queryDeviceLogCount" resultType="int" parameterType="int">
		select count(1) from
		sysmanage_device_log d,
		users u,
		organization o,
		device_basic_info b
		where
		d.device_id = b.id
		and d.user_id = u.id
		and d.org_id = o.id
		and d.delete_time is null
		and d.org_id = #{orgId}
	</select>
	<select id="queryLogIsExite" resultType="String" parameterType="int">
		select event_type from sysmanage_device_log where device_id =
		#{deviceId} and event_type in ("12","13","14") and delete_time is null
		order by update_date desc limit 1
	</select>
	<delete id="deleteSysmanagelogJob" >
		delete FROM sysmanage_log where create_date<![CDATA[<]]>DATE_SUB(CURDATE(), INTERVAL 1 MONTH);
	</delete>
	<delete id="deleteDevicelogJob" >
		delete FROM sysmanage_device_log where create_date<![CDATA[<]]>DATE_SUB(CURDATE(), INTERVAL 1 MONTH);
	</delete>
	<delete id="deleteSecurityLogJob">
		delete FROM security_event_log where create_time<![CDATA[<]]>DATE_SUB(CURDATE(), INTERVAL 1 MONTH);
	</delete>
	<delete id="deleteNetbehaviorlogJob">
		delete FROM netbehavior_loginfo where surftime<![CDATA[<]]>DATE_SUB(CURDATE(), INTERVAL 1 MONTH);
	</delete>
</mapper>